name: CI

on:
  push:
    branches:
      - main
      - master
  pull_request:

jobs:
  frontend-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npm run test:ui

      - name: Build
        run: npm run build

      - name: Enforce bundle budgets
        run: npm run check:bundle-size

  backend-security:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install backend dependencies and audit tool
        run: |
          python -m pip install --upgrade pip
          python -m pip install pip-audit

      - name: Run pip-audit with explicit allowlist policy
        run: |
          pip-audit -r api/requirements.txt --format json > pip-audit.json || true
          python - <<'PY'
          import json
          import sys

          ALLOWLIST = {("ecdsa", "CVE-2024-23342")}

          with open("pip-audit.json", "r", encoding="utf-8") as f:
              report = json.load(f)

          unexpected = []
          for dependency in report.get("dependencies", []):
              package = dependency.get("name", "")
              for vuln in dependency.get("vulns", []):
                  vuln_ids = {vuln.get("id", "")}
                  vuln_ids.update(vuln.get("aliases", []))
                  allowed = any((package, vuln_id) in ALLOWLIST for vuln_id in vuln_ids)
                  if not allowed:
                      unexpected.append(
                          {
                              "package": package,
                              "id": vuln.get("id"),
                              "aliases": vuln.get("aliases", []),
                              "fix_versions": vuln.get("fix_versions", []),
                          }
                      )

          if unexpected:
              print("Unexpected Python vulnerabilities detected:")
              for item in unexpected:
                  print(item)
              sys.exit(1)

          print("Security gate passed: only allowlisted no-fix ecdsa advisory remains (or none found).")
          PY
